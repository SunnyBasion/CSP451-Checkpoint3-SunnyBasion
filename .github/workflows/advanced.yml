name: Advanced Workflows

on:
  schedule:
    # Runs daily at 2:00 AM ET (06:00 UTC)
    - cron: "0 6 * * *"
  workflow_dispatch:

jobs:
  security-check:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: Install dependencies
        run: npm install

      - name: Run security audit
        run: |
          npm audit --json > audit-report.json
          echo "Security audit report generated."

      - name: Create GitHub issue if vulnerabilities found
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const reportPath = path.join(process.cwd(), 'audit-report.json');

            if (!fs.existsSync(reportPath)) {
              console.log('âš ï¸ No audit report found.');
              process.exit(0);
            }

            const report = JSON.parse(fs.readFileSync(reportPath, 'utf8'));
            const totalDeps = report.metadata?.totalDependencies || 0;
            const totalVulns = report.metadata?.vulnerabilities?.total || 0;

            if (totalDeps > 0 && totalVulns > 0) {
              const message = `Total dependencies: ${totalDeps}\nTotal vulnerabilities: ${totalVulns}\n\nPlease review audit-report.json for details.`;

              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'âš ï¸ Vulnerabilities Found in Dependencies',
                body: message
              });

              console.log('ğŸš¨ GitHub issue created for vulnerabilities.');
            } else {
              console.log('âœ… No vulnerabilities found.');
            }
